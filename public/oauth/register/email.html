<!DOCTYPE html>
<html lang="zh-TW" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>電子信箱卡註冊</title>
    <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@1.*/css/pico.min.css">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
    <main class="container">
        <article class="grid">
            <div></div>
            <div>
                <header class="text-center">
                    <h1>電子信箱卡註冊</h1>
                </header>

                <form id="qrForm">
                    <label for="name">
                        姓名
                        <input type="text" id="name" name="name" required>
                    </label>

                    <label for="email">
                        信箱
                        <input type="email" id="email" name="email" required>
                    </label>

                    <button type="submit" id="generateBtn" class="contrast">
                        註冊
                    </button>

                </form>
            </div>
            <div></div>
        </article>
    </main>

    <script>
        document.getElementById('qrForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('name').value.trim();
            const email = document.getElementById('email').value.trim();

            try {
                const response = await fetch('/api/oauth/register/qrcode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name, email })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || '發生錯誤，請稍後再試');
                }

                const data = await response.json();

                // 儲存 transactionId 和 timeout ID
                const transactionId = data.transactionId;
                let pollTimeout;

                // 顯示 QR Code
                Swal.fire({
                    title: '開啟「數位憑證皮夾App」掃描',
                    imageUrl: data.qrCode,
                    showCloseButton: true,
                    showConfirmButton: false,
                    allowOutsideClick: false,
                    html: `<p><a href="${data.deepLink}" target="_blank">打開數位憑證皮夾App</a><p>`,
                    didOpen: () => {
                        // 開始輪詢憑證狀態
                        checkCredentialStatus(transactionId);
                    },
                    willClose: () => {
                        // 清除輪詢計時器
                        if (pollTimeout) {
                            clearTimeout(pollTimeout);
                        }
                    }
                });

                // 輪詢憑證狀態的函數
                async function checkCredentialStatus(transactionId) {
                    try {
                        const response = await fetch(`/api/oauth/register/result?transactionId=${transactionId}`);
                        if (response.status === 200) {
                            Swal.fire({
                                title: '註冊成功',
                                text: '您的數位憑證已成功註冊！',
                                icon: 'success',
                                confirmButtonText: '確定',
                                confirmButtonColor: '#4CAF50'
                            });
                        } else if (response.status === 400) {
                            pollTimeout = setTimeout(() => checkCredentialStatus(transactionId), 5000);
                        } else {
                            throw new Error('憑證驗證失敗');
                        }
                    } catch (error) {
                        console.error('輪詢錯誤:', error);
                        // 發生錯誤時，保持 QR Code 視窗開啟，讓使用者可以重試
                    }
                }

            } catch (error) {
                // 顯示錯誤訊息
                Swal.fire({
                    title: '錯誤',
                    text: error.message,
                    icon: 'error',
                    confirmButtonText: '確定',
                    confirmButtonColor: '#e74c3c'
                });
            }
        });
    </script>
</body>

</html>